{% extends 'base.html' %}

{% block content %}
<div class="container my-4">

  <style>
    /* Ajustes locales para uniformidad de cards en esta p치gina */
    .uniform-card { min-height: 150px; display:flex; flex-direction:column; }
    .list-item-card { min-height: 84px; }
    .list-item-card .card-body { display:flex; justify-content:space-between; align-items:center; gap:1rem; }
    .small-badge {
      width:40px; height:40px; display:inline-flex; align-items:center; justify-content:center;
      border-radius:50%; font-weight:600;
    }
    /* Asegura que listas verticales no rompan el grid */
    .cards-equal > .col { display:flex; }
    .cards-equal .card { flex:1; }
  </style>

  <h1 class="text-center mb-4">Dashboard de Ventas</h1>

  <!-- 游댳 FILTROS GLOBALES -->
  <form method="get" class="row g-3 align-items-end mb-4 p-3 rounded shadow-sm bg-light">
    <!-- Agrupamos los filtros en 10 columnas (md+) y el bot칩n queda en 2 columnas fijas -->
    <div class="col-12 col-md-10 d-flex flex-wrap gap-3 align-items-end">
      <div class="col-12 col-md-3 p-0">
        <label class="form-label fw-semibold">Per칤odo</label>
        <select name="periodo" class="form-select" id="periodo-select">
          <option value="">Seleccionar</option>
          <option value="dia" {% if filtros.periodo == 'dia' %}selected{% endif %}>D칤a</option>
          <option value="semana" {% if filtros.periodo == 'semana' %}selected{% endif %}>Semana</option>
          <option value="mes" {% if filtros.periodo == 'mes' %}selected{% endif %}>Mes</option>
          <option value="anio" {% if filtros.periodo == 'anio' %}selected{% endif %}>A침o</option>
          <option value="personalizado" {% if filtros.periodo == 'personalizado' %}selected{% endif %}>Rango personalizado</option>
        </select>
      </div>

      <div class="col-12 col-md-3 p-0">
        <label class="form-label fw-semibold">Categor칤a</label>
        <select name="categoria" class="form-select">
          <option value="">Todas</option>
          {% for s in secciones %}
            <option value="{{ s.id_section }}" {% if filtros.categoria == s.id_section|stringformat:"s" %}selected{% endif %}>
              {{ s.name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-6 col-md-2 p-0" id="filtro-dia" style="display:none;">
        <label class="form-label fw-semibold">Fecha</label>
        <input type="date" name="fecha_dia" value="{{ filtros.inicio }}" class="form-control">
      </div>

      <div class="col-6 col-md-2 p-0" id="filtro-semana" style="display:none;">
        <label class="form-label fw-semibold">Semana (inicio)</label>
        <input type="date" name="fecha_semana" value="{{ filtros.inicio }}" class="form-control">
      </div>

      <div class="col-6 col-md-2 p-0" id="filtro-mes" style="display:none;">
        <label class="form-label fw-semibold">Mes</label>
        <input type="month" name="mes_filtro" value="{{ filtros.mes|default:filtros.inicio|date:'Y-m' }}" class="form-control">
      </div>

      <div class="col-6 col-md-2 p-0" id="filtro-anio" style="display:none;">
        <label class="form-label fw-semibold">A침o</label>
        <input type="number" name="anio_filtro" value="{{ filtros.anio|default:filtros.inicio.year }}" min="2000" max="2100" class="form-control">
      </div>

      <div class="col-6 col-md-2 p-0" id="filtro-personalizado" style="display:none;">
        <label class="form-label fw-semibold">Desde</label>
        <input type="date" name="fecha_desde" value="{{ filtros.inicio }}" class="form-control">
      </div>
      <div class="col-6 col-md-2 p-0" id="filtro-personalizado-hasta" style="display:none;">
        <label class="form-label fw-semibold">Hasta</label>
        <input type="date" name="fecha_hasta" value="{{ filtros.fin }}" class="form-control">
      </div>
    </div>

    <!-- Botones: siempre ocupan 2 columnas en md+ -->
    <div class="col-12 col-md-2 text-end d-flex flex-column justify-content-end">
      <button type="submit" class="btn btn-primary w-100"><i class="bi bi-funnel"></i> Filtrar</button>
      <a href="{% url 'app' %}" class="btn btn-outline-secondary w-100 mt-2">Limpiar</a>
    </div>
  </form>

  <!-- 游댳 CARDS DE M칄TRICAS -->
  <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-3 mb-4 cards-equal">
    {% for card in cards %}
      <div class="col">
        <div class="card shadow-sm h-100 p-3 uniform-card">
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="fw-bold mb-0">{{ card.titulo }}</h6>
            <i class="bi {{ card.icono }} fs-4 text-secondary"></i>
          </div>
          <h2 class="mt-2 fw-semibold">
            {% if card.tipo == 'dinero' %}
              ${{ card.valor|floatformat:0 }}
            {% else %}
              {{ card.valor }}
            {% endif %}
          </h2>
          <p class="mb-0 small {% if card.variacion >= 0 %}text-success{% else %}text-danger{% endif %}">
            {% if card.variacion >= 0 %}郊쑡% else %}郊짵% endif %}
            {{ card.variacion }}% {{ card.comparacion }}
          </p>
        </div>
      </div>
    {% endfor %}
  </div>

  <!-- 游댳 DASHBOARDS PLOTLY -->
<div class="row g-4 mb-4">
  <div class="col-12 col-lg-6">
    <div class="card h-100 shadow-sm uniform-card">
      <div class="card-body">
        <h6 class="fw-bold mb-2 text-center">Ventas por Categor칤a</h6>
        <p class="text-muted mb-3 text-center">{{ filtros.subtitle }}</p>

        <!-- Aqu칤 va el gr치fico generado por Plotly -->
        <div id="grafico-categoria">
          {{ ventas_categoria|safe }}
        </div>

        <!-- SCRIPT para hacer la leyenda responsiva -->
        <script>
          document.addEventListener("DOMContentLoaded", function() {
            const grafico = document.querySelector("#grafico-categoria .js-plotly-plot");
            if (!grafico) return;

            function ajustarLeyenda() {
              const ancho = window.innerWidth;
              const update = ancho < 992 ? {
                'legend.orientation': 'h',
                'legend.yanchor': 'top',
                'legend.y': -0.1,
                'legend.xanchor': 'center',
                'legend.x': 0.5
              } : {
                'legend.orientation': 'v',
                'legend.yanchor': 'top',
                'legend.y': 0.99,
                'legend.xanchor': 'right',
                'legend.x': 1.15
              };
              Plotly.relayout(grafico, update);
            }

            ajustarLeyenda();
            window.addEventListener('resize', ajustarLeyenda);
          });
        </script>

      </div>
    </div>
  </div>
</div>


    <div class="col-12 col-lg-6">
      <div class="card h-100 shadow-sm uniform-card">
        <div class="card-body">
          <h6 class="fw-bold mb-2 text-center">Ventas Mensuales</h6>
          {% if filtros.hay_filtros %}
            <p class="text-muted mb-3 text-center">{{ filtros.subtitle }}</p>
          {% endif %}
          {{ ventas_mensuales|safe }}
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card h-100 shadow-sm uniform-card">
        <div class="card-body" style="overflow-x:auto;">
          <h6 class="fw-bold mb-2 text-center">An치lisis de Lift</h6>
            <p class="text-muted mb-3">Asociaci칩n entre productos comprados juntos - {{ filtros.subtitle }}</p>

          <div id="lift-container" style="min-width:500px; width:100%;">
            {{ lift_asociacion|safe }}
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card h-100 shadow-sm uniform-card">
        <div class="card-body">
          <h6 class="fw-bold mb-2 text-center">Confianza Media por Categor칤a</h6>
            <p class="text-muted mb-3">Probabilidad de compra conjunta dentro de cada categor칤a - {{ filtros.subtitle }}</p>
          {{ confianza_categoria|safe }}
        </div>
      </div>
    </div>
  </div>

  <!-- 游댳 TOP 5 PRODUCTOS M츼S VENDIDOS -->
  <div class="card shadow-sm mb-4 px-4 py-3" style="max-width: 1200px; margin: 0 auto;">
    <div class="card-body">
      <h5 class="card-title mb-1">Productos M치s Vendidos</h5>
        <p class="text-muted mb-4">Top 5 - {{ filtros.subtitle }}</p>

      <div class="d-flex flex-column gap-3">
        {% for p in top_products %}
        <div class="card bg-secondary-subtle border-0 shadow-sm list-item-card">
          <div class="card-body d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <div class="bg-primary text-white rounded-circle d-flex justify-content-center align-items-center me-3"
                   style="width:40px;height:40px;">
                {{ forloop.counter }}
              </div>
              <div>
                <div class="fw-semibold fs-6 text-primary">{{ p.product__name }}</div>
                <small class="text-muted">{{ p.total_vendidos }} unidades vendidas</small>
              </div>
            </div>
            <div class="text-end">
              <span class="fw-bold fs-5">${{ p.total_ventas|floatformat:0 }}</span>
            </div>
          </div>
        </div>
        {% empty %}
        <div class="card border-0 shadow-none bg-light text-center py-3">
          <div class="text-muted">No hay datos disponibles</div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- 游댳 VENTAS RECIENTES (estilo Top Products, fondo blanco, emoji carrito) -->
  <div class="card shadow-sm mb-4 px-4 py-3" style="max-width: 1200px; margin: 0 auto; background:#fff;">
    <div class="card-body">
      <h5 class="card-title mb-1">Ventas Recientes</h5>
      <p class="text-muted mb-4">칔ltimas ventas del d칤a</p>

      <div class="d-flex flex-column gap-3">
        {% for v in ventas_recientes %}
        <div class="card border-0 shadow-sm list-item-card">
          <div class="card-body d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <div class="small-badge bg-light text-dark me-3">游</div>
              <div>
                <div class="fw-semibold fs-6 text-primary">{{ v.producto }}</div>
                <small class="text-muted">{{ v.cantidad }} unidades</small>
              </div>
            </div>
            <div class="text-end">
              <span class="fw-bold fs-5">${{ v.total|floatformat:0 }}</span>
            </div>
          </div>
        </div>
        {% empty %}
        <div class="card border-0 shadow-none bg-light text-center py-3">
          <div class="text-muted">No hay ventas disponibles</div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- 游댳 CLIENTES FRECUENTES (estilo cards para armon칤a) -->
  <div class="card shadow-sm mb-4 px-4 py-3" style="max-width: 1200px; margin: 0 auto;">
    <div class="card-body">
      <h5 class="card-title mb-1">Clientes Frecuentes</h5>
        <p class="text-muted mb-3">Clientes con mayor n칰mero de 칩rdenes registradas - {{ filtros.subtitle }}</p>

      <div class="d-flex flex-column gap-3">
        {% for c in clientes_frecuentes %}
        <div class="card bg-secondary-subtle border-0 shadow-sm list-item-card">
          <div class="card-body d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <div class="bg-primary text-white rounded-circle d-flex justify-content-center align-items-center me-3"
                   style="width:40px;height:40px;">
                {{ forloop.counter }}
              </div>
              <div>
                <div class="fw-semibold">{{ c.id_client }}</div>
                <small class="text-muted">칍rdenes: {{ c.total_pedidos }}</small>
              </div>
            </div>
            <div class="text-end">
              <div class="fw-bold">${{ c.total_gastado|floatformat:0 }}</div>
              <small class="text-muted d-block">{{ c.ultima_compra|date:"d/m/Y" }}</small>
            </div>
          </div>
        </div>
        {% empty %}
        <div class="card border-0 shadow-none bg-light text-center py-3">
          <div class="text-muted">No hay datos disponibles</div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

</div>

<!-- 游댳 Script para mostrar filtros din치micos -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectPeriodo = document.getElementById('periodo-select');

    const filtros = {
        'dia': document.getElementById('filtro-dia'),
        'semana': document.getElementById('filtro-semana'),
        'mes': document.getElementById('filtro-mes'),
        'anio': document.getElementById('filtro-anio'),
        'personalizado': [
            document.getElementById('filtro-personalizado'),
            document.getElementById('filtro-personalizado-hasta')
        ]
    };

    function actualizarFiltros() {
        Object.keys(filtros).forEach(key => {
            if(Array.isArray(filtros[key])){
                filtros[key].forEach(el => el.style.display = (selectPeriodo.value === key) ? 'block' : 'none');
            } else {
                filtros[key].style.display = (selectPeriodo.value === key) ? 'block' : 'none';
            }
        });
    }

    selectPeriodo.addEventListener('change', actualizarFiltros);
    actualizarFiltros(); // Inicializa al cargar la p치gina
});
</script>

{% endblock %}